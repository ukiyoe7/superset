

WITH FIS AS (SELECT FISCODIGO FROM TBFIS WHERE FISTPNATOP IN ('V','R','SR')),
  
  SETOR AS (SELECT ZOCODIGO,ZODESCRICAO SETOR FROM ZONA WHERE ZOCODIGO IN (20,21,22,23,24,25,26,27,28)),
  
  ENDE AS (SELECT ENDCODIGO,CLICODIGO,SETOR FROM ENDCLI INNER JOIN SETOR ON ENDCLI.ZOCODIGO=SETOR.ZOCODIGO WHERE ENDFAT='S'),
  
  PEDEMIS AS (SELECT ID_PEDIDO,
                      PEDDTEMIS,
                       SETOR
                        FROM PEDID P
                         INNER JOIN ENDE E ON P.CLICODIGO=E.CLICODIGO AND P.ENDCODIGO=E.ENDCODIGO
                          WHERE PEDDTEMIS 
                           BETWEEN (CURRENT_DATE-1) - EXTRACT(DAY FROM (CURRENT_DATE-1)) + 1 AND 'YESTERDAY' AND PEDSITPED<>'C' AND PEDLCFINANC IN ('S', 'L','N')),
  
  PEDBAIXA AS (SELECT ID_PEDIDO,
                       PEDDTBAIXA,
                        SETOR 
                         FROM PEDID P
                          INNER JOIN ENDE E ON P.CLICODIGO=E.CLICODIGO AND P.ENDCODIGO=E.ENDCODIGO
                           WHERE PEDDTBAIXA 
                            BETWEEN (CURRENT_DATE-1) - EXTRACT(DAY FROM (CURRENT_DATE-1)) + 1 AND 'YESTERDAY' AND PEDSITPED<>'C' AND PEDLCFINANC IN ('S', 'L','N')),
  
  PDEMIS2 AS (SELECT PEDDTEMIS,
                     SETOR, 
                      SUM(PDPUNITLIQUIDO*PDPQTDADE)VRVENDA 
                       FROM PDPRD PD
                        INNER JOIN FIS F ON PD.FISCODIGO=F.FISCODIGO
                         INNER JOIN PEDEMIS ON PD.ID_PEDIDO=PEDEMIS.ID_PEDIDO
                          GROUP BY 1,2),
  
  PDBAIXA2 AS (SELECT PEDDTBAIXA,
                      SETOR, 
                       SUM(PDPUNITLIQUIDO*PDPQTDADE)VRVENDA 
                        FROM PDPRD PD
                         INNER JOIN FIS F ON PD.FISCODIGO=F.FISCODIGO
                          INNER JOIN PEDBAIXA ON PD.ID_PEDIDO=PEDBAIXA.ID_PEDIDO
                           GROUP BY 1,2)
  
  SELECT PEDDTEMIS DATA,
          SETOR,
           VRVENDA,
             'EMISSAO' AS TIPO
   FROM PDEMIS2 
    UNION
    SELECT PEDDTBAIXA DATA,
            SETOR, 
             VRVENDA,
              'BAIXA' AS TIPO
     FROM PDBAIXA2