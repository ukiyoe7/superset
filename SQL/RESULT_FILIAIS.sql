WITH FIS AS (SELECT FISCODIGO FROM TBFIS WHERE FISTPNATOP IN ('V','R','SR')
),

NF AS (SELECT EMPCODIGO,CLICODIGO,NFDTEMIS,NFCODIGO,NFLCFINANC FROM NOTAS
WHERE NFDTEMIS BETWEEN (CURRENT_DATE) - EXTRACT(DAY FROM CURRENT_DATE) + 1 AND 'TODAY'
AND NFSIT = 'N'
),

CALC AS(SELECT 
NP.EMPCODIGO,
NP.NFCODIGO,
NP.FISCODIGO,
CLICODIGO,
NFDTEMIS DATA, 
NFPVRCONTABIL,
NFPVRPIS,
NFPVRICMS,
NFPVRCOFINS,
CAST(SUM(NFPUNITLIQUIDO*NFPQTDADE)  AS NUMERIC(18,2)) VRVENDA,
CAST(SUM(NFPVRFRETE)AS NUMERIC(18,2)) FRETE,
(CAST(SUM(NFPUNITLIQUIDO*NFPQTDADE)  AS NUMERIC(18,2)) + CAST(SUM(NFPVRFRETE)AS NUMERIC(18,2))) VRTOTAL,
(CAST(SUM(NFPUNITLIQUIDO*NFPQTDADE)  AS NUMERIC(18,2)) + CAST(SUM(NFPVRFRETE)AS NUMERIC(18,2))) - 
CAST(SUM(NFPVRICMS) AS NUMERIC(18,2)) - 
CAST(SUM(NFPVRPIS) AS NUMERIC(18,2)) -
CAST(SUM(NFPVRCOFINS) AS NUMERIC(18,2)) VRLIQUIDO

FROM NFPRO NP
INNER JOIN NF ON NP.NFCODIGO=NF.NFCODIGO AND NP.EMPCODIGO=NF.EMPCODIGO
INNER JOIN FIS ON NP.FISCODIGO=FIS.FISCODIGO
WHERE
(NP.NFPLCFINAN = 'S' AND NF.NFLCFINANC <> 'L' OR  NP.NFPLCFINAN = 'N' OR  NF.NFLCFINANC = 'L' AND NP.NFPLCFINAN = 'S' )
GROUP BY 1,2,3,4,5,6,7,8,9
)


SELECT
DATA,
EMPCODIGO,
VRLIQUIDO
FROM CALC C
WHERE EMPCODIGO<>1